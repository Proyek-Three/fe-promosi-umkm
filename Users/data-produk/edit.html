<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard User</title>
    <meta name="author" content="David Grzyb" />
    <meta name="description" content="" />

    <!-- Tailwind -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="../../assets/css/users.css" />
    <script src="../../assets/js/profile.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-gray-100 font-family-karla flex">
    <aside class="relative bg-sidebar h-auto w-64 hidden sm:block shadow-xl">
      <div class="p-6">
        <a
          class="text-white text-2xl font-semibold uppercase hover:text-gray-300"
          >Dashboard</a
        >
      </div>
      <nav class="text-white text-base font-semibold pt-3">
        <a
          href="../dashboard.html"
          class="flex items-center text-white opacity-75 hover:opacity-100 py-4 pl-6 nav-item"
        >
          <i class="fas fa-tachometer-alt mr-3"></i>
          Dashboard
        </a>
        <a
          href="index.html"
          class="flex items-center active-nav-link text-white py-4 pl-6 nav-item"
        >
          <i class="fas fa-table mr-3"></i>
          Product Data
        </a>
        <a
          href="../profile/index.html"
          class="flex items-center text-white py-4 pl-6 nav-item"
        >
          <i class="fa-solid fa-user mr-3"></i>
          Profile
        </a>
      </nav>
    </aside>

    <div class="w-full flex flex-col">
      <!-- Desktop Header -->
      <header class="w-full items-center bg-white py-2 px-6 hidden sm:flex">
        <div class="w-1/2"></div>
        <div x-data="{ isOpen: false }" class="relative w-1/2 flex justify-end">
          <button
            @click="isOpen = !isOpen"
            class="realtive z-10 w-12 h-12 rounded-full overflow-hidden border-gray-400 hover:border-gray-300 focus:border-gray-300 focus:outline-none"
          >
            <i class="fa-solid fa-bars"></i>
          </button>
          <button
            x-show="isOpen"
            @click="isOpen = false"
            class="h-full w-full fixed inset-0 cursor-default"
          ></button>
          <div
            x-show="isOpen"
            class="absolute w-32 bg-white rounded-lg shadow-lg py-2 mt-16"
          >
            <a
              href="../profile/index.html"
              class="block px-4 py-2 account-link hover:text-white"
              ><i class="fa-solid fa-user mr-3"></i>Profile</a
            >
            <a href="#" class="block px-4 py-2 account-link hover:text-white"
              ><i class="fa-solid fa-right-from-bracket mr-3"></i>Sign Out</a
            >
          </div>
        </div>
      </header>

      <!-- Mobile Header & Nav -->
      <header
        x-data="{ isOpen: false }"
        class="w-full bg-sidebar py-5 px-6 sm:hidden"
      >
        <div class="flex items-center justify-between">
          <a
            href="index.html"
            class="text-white text-3xl font-semibold uppercase hover:text-gray-300"
            >Dashboard</a
          >
          <button
            @click="isOpen = !isOpen"
            class="text-white text-3xl focus:outline-none"
          >
            <i x-show="!isOpen" class="fas fa-bars"></i>
            <i x-show="isOpen" class="fas fa-times"></i>
          </button>
        </div>

        <!-- Dropdown Nav -->
        <nav :class="isOpen ? 'flex': 'hidden'" class="flex flex-col pt-4">
          <a
            href="../dashboard.html"
            class="flex items-center text-white py-2 pl-4 nav-item"
          >
            <i class="fas fa-tachometer-alt mr-3"></i>
            Dashboard
          </a>
          <a
            href="tables.html"
            class="flex items-center active-nav-link text-white opacity-75 hover:opacity-100 py-2 pl-4 nav-item"
          >
            <i class="fas fa-table mr-3"></i>
            Product Data
          </a>
          <a
            href="../profile/index.html"
            class="flex items-center text-white opacity-75 hover:opacity-100 py-2 pl-4 nav-item"
          >
            <i class="fas fa-user mr-3"></i>
            Profile
          </a>
          <a
            href="#"
            class="flex items-center text-white opacity-75 hover:opacity-100 py-2 pl-4 nav-item"
          >
            <i class="fas fa-sign-out-alt mr-3"></i>
            Sign Out
          </a>
        </nav>
      </header>

      <!-- CONTENT -->
      <div class="px-6 py-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          Edit Product Data
        </h2>

        <form
          id="formEditProduct"
          class="bg-white p-6 rounded-lg shadow-md dark:bg-gray-800"
          enctype="multipart/form-data"
        >
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <!-- Input Nama Produk -->
            <div>
              <label
                for="product_name"
                class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300"
              >
                Product Name
              </label>
              <input
                type="text"
                id="product_name"
                name="product_name"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                placeholder="Product Name"
                required
              />
            </div>

            <!-- Input Harga Produk -->
            <div>
              <label
                for="price"
                class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300"
              >
                Price
              </label>
              <input
                type="text"
                id="price"
                name="price"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                placeholder="Price"
                required
                oninput="formatRupiah(this)"
              />
            </div>

            <script>
              function formatRupiah(input) {
                let value = input.value.replace(/[^\d]/g, ""); // Menghapus semua karakter selain angka
                let formattedValue = "";

                // Format angka menjadi format Rupiah
                for (let i = value.length - 1; i >= 0; i--) {
                  formattedValue = value[i] + formattedValue;
                  if ((value.length - i) % 3 === 0 && i !== 0) {
                    formattedValue = "." + formattedValue;
                  }
                }

                // Set value ke input dengan format Rupiah
                if (formattedValue) {
                  input.value = "Rp " + formattedValue; // Menambahkan Rp di depan
                } else {
                  input.value = ""; // Jika kosong, kosongkan field
                }
              }
            </script>

            <!-- Input Upload File -->
            <div>
              <label
                class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300"
                for="file_input"
                >Upload file</label
              >
              <input
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                id="image"
                name="image"
                type="file"
              />
            </div>

            <!-- Input Kategori Produk -->
            <div>
              <label
                for="category"
                class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300"
              >
                Category
              </label>
              <select
                id="category_name"
                name="category_name"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                required
              >
                <option value="" disabled selected>Select Category</option>
              </select>
            </div>
          </div>

          <!-- Input Deskripsi Produk -->
          <div class="mt-4">
            <label
              for="description"
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300"
            >
              Description
            </label>
            <textarea
              id="description"
              name="description"
              rows="4"
              class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-3 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
              placeholder="Description"
              required
            ></textarea>
          </div>

          <!-- Foto -->
          <div class="mt-4">
            <label
              for="image_preview"
              class="block mb-2 text-sm font-medium text-gray-900 dark:text-gray-300"
            >
              Image Preview
            </label>
            <img
              id="image_preview"
              class="w-32 h-32 object-cover rounded-lg"
              alt="Image Preview"
            />
          </div>

          <!-- Tombol Submit -->
          <button
            type="submit"
            onclick="return window.location.href= 'index.html'"
            class="mt-6 text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-gray-500 dark:hover:bg-gray-600 dark:focus:ring-gray-800"
          >
            Back
          </button>
          <button
            type="submit"
            id="editProductForm"
            class="mt-6 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-6 py-3 text-center dark:bg-blue-500 dark:hover:bg-blue-600 dark:focus:ring-blue-800"
          >
            Edit
          </button>
        </form>
      </div>

      <!-- CONTENT END -->
    </div>

    <script>
      // Fungsi untuk mendapatkan cookie berdasarkan nama
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(";").shift();
      }

      // Fungsi untuk mendekode JWT dan mendapatkan payload
      function decodeJwt(token) {
        const base64Url = token.split(".")[1]; // Ambil bagian payload (second part of JWT)
        const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/"); // Decode URL-safe Base64
        const jsonPayload = decodeURIComponent(
          atob(base64)
            .split("")
            .map(function (c) {
              return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            })
            .join("")
        );
        return JSON.parse(jsonPayload); // Kembalikan payload yang sudah didekode
      }

      // Fungsi untuk memformat angka ke format Rupiah
      function formatRupiah(angka, prefix = "Rp ") {
        return prefix + angka.toLocaleString("id-ID");
      }

      // Ketika halaman di-load, ambil ID produk dari URL atau parameter dan dapatkan data produk
      document.addEventListener("DOMContentLoaded", () => {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get("productId"); // Ambil ID produk dari query string URL

        if (productId) {
          loadCategories(); // Muat kategori sebelum produk
          getProductById(productId); // Ambil data produk jika ID ada
        }
      });

      // Fungsi untuk mendapatkan data kategori dan mengisi dropdown
      async function loadCategories() {
        const token = getCookie("token"); // Ambil token dari cookie

        // Periksa apakah token ada
        if (!token) {
          alert("No token found. Please log in first.");
          return;
        }

        try {
          // Ambil data kategori
          const response = await fetch(
            "https://bp-promosi-umkm-0fd00e17451e.herokuapp.com/category",
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const categories = await response.json();
          console.log(categories);

          // Ambil elemen dropdown
          const categoryDropdown = document.getElementById("category_name");

          // Hapus semua opsi yang ada
          categoryDropdown.innerHTML = "";

          // Tambahkan opsi default
          const defaultOption = document.createElement("option");
          defaultOption.value = "";
          defaultOption.textContent = "Select Category";
          defaultOption.disabled = true;
          defaultOption.selected = true;
          categoryDropdown.appendChild(defaultOption);

          // Tambahkan kategori ke dalam dropdown
          categories.forEach((category) => {
            const option = document.createElement("option");
            option.value = category.id;
            option.textContent = category.category_name;
            categoryDropdown.appendChild(option);
          });
        } catch (error) {
          console.error("Error fetching categories:", error);
        }
      }

      let previousImage = ""; // Simpan gambar lama

      // Fungsi untuk mendapatkan data produk berdasarkan ID
      async function getProductById(productId) {
        const token = getCookie("token"); // Ambil token dari cookie

        if (!token) {
          alert("No token found. Please log in first.");
          return;
        }

        try {
          const response = await fetch(
            `https://bp-promosi-umkm-0fd00e17451e.herokuapp.com/product/${productId}`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const product = await response.json();
          console.log(product);

          document.getElementById("product_name").value = product.product_name;
          document.getElementById("price").value = formatRupiah(product.price); // Menampilkan harga dalam format Rupiah
          document.getElementById("description").value = product.description;
          document.getElementById("category_name").value = product.category.id;

          // Menyimpan gambar lama
          previousImage = product.image;

          console.log("Previous image:", previousImage);

          // Menampilkan gambar lama
          const imageElement = document.getElementById("image_preview");
          if (imageElement) {
            imageElement.src = previousImage;
          }
        } catch (error) {
          console.error("Error fetching product data:", error);
        }
      }

      async function urlToFile(url, filename, mimeType) {
        const response = await fetch(url);
        const blob = await response.blob();
        return new File([blob], filename, { type: mimeType });
      }

      document
        .getElementById("formEditProduct")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const token = getCookie("token");

          if (!token) {
            alert("No token found. Please log in first.");
            window.location.href = "../../auth/login.html";
            return;
          }

          const decodedToken = decodeJwt(token);
          const userId = decodedToken.user_id;
          console.log("User ID:", userId);

          const productId = new URLSearchParams(window.location.search).get(
            "productId"
          );
          const productName = document.getElementById("product_name").value;
          const price = document
            .getElementById("price")
            .value.replace(/[^\d]/g, ""); // Menghapus format Rupiah saat submit
          const description = document.getElementById("description").value;
          const categoryId = document.getElementById("category_name").value;
          const imageFile = document.getElementById("image").files[0];

          const statusId = "67910940c6747400bebfe2cd";

          const formData = new FormData();
          formData.append("ProductName", productName);
          formData.append("price", price); // Menggunakan harga yang sudah diproses
          formData.append("description", description);
          formData.append("category.id", categoryId);
          formData.append("status.id", statusId);
          formData.append("user.id", userId);

          // Jika ada gambar baru, gunakan gambar baru
          if (imageFile) {
            formData.append("image", imageFile);
          } else if (previousImage) {
            // Jika tidak ada gambar baru, unduh gambar lama dan kirim sebagai file
            try {
              const oldImageFile = await urlToFile(
                previousImage,
                "old_image.jpg",
                "image/jpeg"
              );
              formData.append("image", oldImageFile);
            } catch (error) {
              console.error("Failed to fetch old image:", error);
              Swal.fire({
                icon: "error",
                title: "Error",
                text: "Failed to fetch the old image.",
                showConfirmButton: true,
              });
              return;
            }
          } else {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "Image is required. Please upload an image.",
              showConfirmButton: true,
            });
            return;
          }

          console.log("Form data:", formData);

          try {
            const response = await fetch(
              `https://bp-promosi-umkm-0fd00e17451e.herokuapp.com/update/product/${productId}`,
              {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              }
            );

            const result = await response.json();
            console.log(result);

            if (response.ok) {
              Swal.fire({
                icon: "success",
                title: "Success",
                text: result.message,
                showConfirmButton: true,
              }).then(() => {
                window.location.href = "index.html";
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Error",
                text:
                  result.message ||
                  "An error occurred while updating the product.",
                showConfirmButton: true,
              });
            }
          } catch (error) {
            console.error("Error:", error);
            Swal.fire({
              icon: "error",
              title: "Error",
              text: "An error occurred while updating the product.",
              showConfirmButton: true,
            });
          }
        });
    </script>

    <!-- Fetch -->
    <!-- <script type="module" src="../../assets/js/fetch_edit_product.js"></script> -->
    <!-- <script
      type="module"
      src="../../assets/js/config/url_put_product.js"
    ></script> -->
    <!-- <script
      type="module"
      src="../../assets/js/controller/put_product.js"
    ></script> -->
    <!-- AlpineJS -->
    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>
    <!-- Font Awesome -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"
      integrity="sha256-KzZiKy0DWYsnwMF+X1DvQngQ2/FxF7MF3Ff72XcpuPs="
      crossorigin="anonymous"
    ></script>
    <!-- ChartJS -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"
      integrity="sha256-R4pqcOYV8lt7snxMQO/HSbVCFRPMdrhAFMH+vr9giYI="
      crossorigin="anonymous"
    ></script>
  </body>
</html>
